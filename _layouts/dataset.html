---
layout: default
---
{% include breadcrumbs.html parent="Datasets" %}
{% assign schema = page.schema | default: site.schema %}
{% assign dataset_fields = site.data.schemas[schema].dataset_fields %}
{% assign dataset_system_fields = "title|organization|notes|license" | split: "|" %}
{% assign resource_fields = site.data.schemas[schema].resource_fields %}
{% assign resource_system_fields = "name|url|format|description" | split: "|" %}

{% assign organization = site.organizations | where:"title",page.organization | first %}
{% capture organization_url %}{{ site.baseurl }}/datasets/?organization={{ organization.title | slugify }}{% endcapture %}

<div data-component="view-switcher">
  <div class="row" data-component="dataset-display" data-hook="view" data-view="display" typeof="dcat:Dataset" resource="{{ page.url }}">
    {% if organization %}
    <div class="col-sm-3" property="dct:publisher" resource="{{ organization_url }}">
      <div class="panel panel-default">
        <div class="panel-heading">
          {% if organization.logo and organization.logo != empty %}
          <a href="{{ site.baseurl }}/datasets/?organization={{ organization.title | slugify }}" class="thumbnail"><img src="{{ organization.logo }}" alt="{{ organization.title }} logo"></a>
          {% endif %}
        </div>
        <div class="panel-body">
          <h3>
            <a href="{{ organization_url }}" about="{{ organization_url }}" property="foaf:homepage">
              <span property="foaf:name">{{ organization.title }}</span>
            </a>
          </h3>
          {{ organization.description }}
        </div>
      </div>
      <div class="view-code-link">
        <a href="{{site.repo}}tree/gh-pages/{{page.path}}" target="_blank"><i class="fa fa-code"></i> Open in GitHub</a>
      </div>
    </div>
    <div class="col-sm-9">
      {% else %}
      <div class="col-sm-12">
        {% endif %}
        <h1>
          <span property="dct:title">{{ page.title }}</span>
          <a href="?view=edit" class="pull-right btn btn-default admin-only" data-hook="edit-dataset-btn">Edit</a>
        </h1>
        <p property="dct:description">{{ page.notes }}</p>

        <h2>Resources</h2>
        <ul>
          {% for resource in page.resources %}
          <li data-hook="resource-item" property='dcat:distribution' typeof='dcat:Distribution'>
            <a href="{{ resource.url }}" property='dcat:accessURL'><span property="dct:title">{{ resource.name }}</span></a>
            {% if resource.format %}<span class="label label-default" property='dcat:mediaType'>{{ resource.format}}</span>{% endif %}
            <a href="#" class="show-resource-details" data-hook="show-resource-details">(Details)</a>
            {% if resource.description %}<div class="resource-description">{{ resource.description }}</div>{% endif %}
            <table class="table table-striped table-condensed resource-details" data-hook="resource-details">
              {% for field in resource_fields %}
              {% unless resource_system_fields contains field.field_name %}
              {% assign value = resource[field[field_name]] %}
              {% if value %}
              {% if field.display_template %}
              {% include {{ field.display_template }} field=field value=value %}
              {% else %}
              <tr>
                <th>{{ field.label }}</th>
                <td>{{ value }}</td>
              </tr>
              {% endif %}
              {% endif %}
              {% endunless %}
              {% endfor %}
            </table>
          </li>
          {% endfor %}
        </ul>

        {% if page.resources %}
        <h2>Preview resources</h2>
        <div id="resource-preview-wrapper">
          <!-- Nav tabs -->
          <ul class="nav nav-tabs" role="tablist" id="resource-preview-tabs">

          </ul>

          <!-- Tab panes -->
          <div class="tab-content" id="resource-preview-tabs-content">

          </div>
        </div>
        {% endif %}

        <h2>Additional Info</h2>
        <table class="table table-striped dataset-details">
          {% if page.license and page.license != empty %}
          <tr>
            <th>License</th>
            <td>
              <a property="dct:license" resource="{{ page.license }}" href="{{ page.license }}">
                {{ site.data.licenses[page.license] }}
              </a>
            </td>
          </tr>
          {% endif %}
          {% for field in dataset_fields %}
          {% unless dataset_system_fields contains field.field_name %}
          {% assign value = page[field[field_name]] %}
          {% if value %}
          {% if field.display_template %}
          {% include {{ field.display_template }} field=field value=value %}
          {% else %}
          <tr>
            <th>{{ field.label }}</th>
            <td>{{ value }}</td>
          </tr>
          {% endif %}
          {% endif %}
          {% endunless %}
          {% endfor %}

        </table>
      </div>
    </div>

    <div class="row" data-hook="view" data-view="edit">
      <div class="col-sm-8 col-sm-offset-2">
        {% include dataset-form.html dataset=page %}
      </div>
      <div class="col-sm-2">
        <a href="{{ site.baseurl }}{{ page.url }}" class="btn btn-default pull-right">Cancel</a>
      </div>
    </div>
  </div>

  <!-- Include the JS for AG Grid -->
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>
  <!-- Include the core CSS, this is needed by the grid -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" />
  <!-- Include the theme CSS, only need to import the theme you are going to use -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js" integrity="sha512-SGWgwwRA8xZgEoKiex3UubkSkV1zSE1BS6O4pXcaxcNtUlQsOmOmhVnDwIvqGRfEmuz83tIGL13cXMZn6upPyg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    var resources = {{ page.resources | jsonify}};

    if (resources) {

      var csv_files = resources.filter(x => x.format == "CSV");

      for (let i = 0; i < csv_files.length; i++) {
        var csv_file = csv_files[i];
        var tab = createTab(csv_file.name, i === 0);

        csvToOutput("https://cors-proxy.opendatascotland.workers.dev/" + csv_file.url, tab);

      }
    }

    function createTab(tabName, isActive){
      var tabUUID = createUUID(); 

      $("#resource-preview-tabs").append(`<li role="presentation" ${isActive ? 'class="active"' : ''}><a href="#${tabUUID}" aria-controls="${tabUUID}" role="tab" data-toggle="tab">${tabName}</a></li>`)
      $("#resource-preview-tabs-content").append(`<div role="tabpanel" style="height:500px" class="tab-pane ${isActive ? "active" : ""}" id="${tabUUID}"></div>`)

      return tabUUID;
    }

    function createUUID() {
      return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      )
    }

    function csvToOutput(csvUrl, tabId) {

      var gridId = `csv-${tabId}`;

      // Create CSV DOM
      $(`#${tabId}`).append(`<div id="${gridId}" class="ag-theme-alpine" style="height:100%"></div>`)
      
      // Fetch data from server
      // TODO: Some CSVs really big and take a while to load. Can we do a pre-flight HEAD request and not load large files unless the user specifically asks for them
      // Also, even for semi-large files, we might want some sort of loading spinner  
      fetch(csvUrl)
        .then(response => response.text())
        .then(data => {
          var csvData = Papa.parse(data, { header: true });

          var columnDefs = Object.keys(csvData.data[0]).map(x => { return { field: x } })

          // Grid Options are properties passed to the grid
          const gridOptions = {

            columnDefs: columnDefs,

            // default col def properties get applied to all columns
            defaultColDef: { sortable: true, filter: true },

            rowSelection: 'multiple', // allow rows to be selected
            animateRows: true, // have rows animate to new positions when sorted
          };

          // get div to host the grid
          const eGridDiv = document.getElementById(gridId );
          // new grid instance, passing in the hosting DIV and Grid Options
          new agGrid.Grid(eGridDiv, gridOptions);

          // load fetched data into grid
          gridOptions.api.setRowData(csvData.data);
        });
    }

  </script>